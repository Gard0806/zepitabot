<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zepita Bot - Asistente de Men√∫s</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            background: transparent;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom: 4px solid #667eea;
            color: #667eea;
        }

        .content {
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Estilos para Admin */
        .admin-section {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1em;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-large {
            padding: 25px 50px;
            font-size: 1.5em;
            margin: 10px;
            min-width: 250px;
        }

        .menu-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
        }

        .menu-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .menu-item h3 {
            color: #667eea;
            font-size: 1.3em;
        }

        .price {
            color: #28a745;
            font-weight: bold;
            font-size: 1.2em;
        }

        /* Chat Interface */
        .chat-container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .chat-header {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            max-width: 80%;
            line-height: 1.6;
            font-size: 1.1em;
        }

        .message.bot {
            background: #e3f2fd;
            margin-right: auto;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .chat-input {
            display: flex;
            padding: 20px;
            gap: 10px;
            border-top: 2px solid #e0e0e0;
        }

        .chat-input input {
            flex: 1;
        }

        .voice-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
        }

        .voice-btn.active {
            background: #c82333;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Lista de Pedidos */
        .orders-summary {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
        }

        .order-card {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
        }

        .order-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .order-item {
            padding: 10px;
            background: white;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .total-section {
            background: #28a745;
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .total-section h2 {
            font-size: 2em;
        }

        .week-selector {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .week-selector h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .communication-choice {
            text-align: center;
            padding: 40px;
        }

        .communication-choice h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .whatsapp-section {
            background: #25D366;
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }

        .whatsapp-section h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .whatsapp-link {
            background: white;
            color: #25D366;
            padding: 15px 30px;
            border-radius: 10px;
            text-decoration: none;
            display: inline-block;
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 10px;
        }

        .alert {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .alert-success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }

        .alert-info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            color: #0c5460;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .btn-large {
                min-width: 100%;
                margin: 10px 0;
            }
            
            .tab {
                font-size: 0.9em;
                padding: 15px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è Zepita Bot</h1>
            <p>Tu Asistente Inteligente de Men√∫s</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showSection('admin')">üë®‚Äçüç≥ Maestro de Banquetes</button>
            <button class="tab" onclick="showSection('user')">üë§ Usuario</button>
            <button class="tab" onclick="showSection('orders')">üìã Lista de Pedidos</button>
        </div>

        <div class="content">
            <!-- SECCI√ìN ADMINISTRADOR -->
            <div id="admin" class="section active">
                <!-- Pantalla de Login -->
                <div id="adminLogin" class="admin-section">
                    <div style="max-width: 500px; margin: 50px auto; text-align: center;">
                        <div style="background: #f8f9fa; padding: 40px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                            <h2 style="color: #667eea; margin-bottom: 20px; font-size: 2em;">
                                üîê Acceso Maestro de Banquetes
                            </h2>
                            <p style="color: #666; margin-bottom: 30px; font-size: 1.1em;">
                                Ingresa el c√≥digo de acceso para continuar
                            </p>
                            <div class="form-group">
                                <input type="password" 
                                       id="adminCode" 
                                       placeholder="C√≥digo de acceso" 
                                       style="text-align: center; font-size: 1.3em; letter-spacing: 3px;"
                                       onkeypress="if(event.key === 'Enter') verifyAdminCode()">
                            </div>
                            <button class="btn btn-primary btn-large" onclick="verifyAdminCode()">
                                üîì Ingresar
                            </button>
                            <div id="loginError" style="display: none; margin-top: 20px;">
                                <div class="alert" style="background: #f8d7da; border: 2px solid #dc3545; color: #721c24;">
                                    ‚ùå C√≥digo incorrecto. Intenta nuevamente.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel de Administraci√≥n -->
                <div id="adminPanel" class="admin-section" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div>
                            <strong style="color: #667eea; font-size: 1.1em;">üë®‚Äçüç≥ Sesi√≥n Activa</strong>
                        </div>
                        <button class="btn btn-danger" onclick="logoutAdmin()" style="font-size: 1em;">
                            üö™ Cerrar Sesi√≥n
                        </button>
                    </div>

                    <h2 style="text-align: center; color: #667eea; margin-bottom: 30px; font-size: 2em;">
                        Panel del Maestro de Banquetes
                    </h2>

                    <div class="week-selector">
                        <h2>Selecciona el Jueves para el Men√∫</h2>
                        <select id="thursdaySelector" class="form-control" onchange="updateThursdayDisplay()" style="font-size: 1.2em; padding: 15px;">
                            <option value="">-- Selecciona un jueves --</option>
                        </select>
                        <p id="thursdayDisplay" style="margin-top: 15px; font-size: 1.2em; color: #666;"></p>
                        <div id="deadlineWarning" style="margin-top: 15px; display: none;">
                            <div class="alert" style="background: #fff3cd; border: 2px solid #ffc107; color: #856404;">
                                ‚è∞ <strong>Importante:</strong> Los usuarios podr√°n hacer pedidos hasta las <strong>18:00 hrs del jueves</strong>. Despu√©s de esa hora, el men√∫ se bloquear√° autom√°ticamente.
                            </div>
                        </div>
                        <div id="menuExpired" style="margin-top: 15px; display: none;">
                            <div class="alert" style="background: #f8d7da; border: 2px solid #dc3545; color: #721c24;">
                                ‚ùå <strong>Men√∫ Expirado:</strong> Este men√∫ ya no acepta pedidos. El plazo venci√≥ el jueves a las 18:00 hrs.
                            </div>
                        </div>
                        <div id="menuDeleteWarning" style="margin-top: 15px; display: none;">
                            <div class="alert" style="background: #f8d7da; border: 2px solid #dc3545; color: #721c24;">
                                üóëÔ∏è <strong>Eliminaci√≥n Autom√°tica:</strong> Este men√∫ ser√° eliminado autom√°ticamente 3 d√≠as despu√©s del jueves (el domingo a las 23:59 hrs).
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üìù Nombre del Plato</label>
                        <input type="text" id="dishName" placeholder="Ej: Pollo al horno con papas">
                    </div>

                    <div class="form-group">
                        <label>üí∞ Precio (Bs.)</label>
                        <input type="number" id="dishPrice" placeholder="Ej: 25" step="0.5">
                    </div>

                    <div class="form-group">
                        <label>üìÑ Descripci√≥n (opcional)</label>
                        <textarea id="dishDescription" rows="3" placeholder="Descripci√≥n del plato..."></textarea>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-primary btn-large" onclick="addDishToMenu()">
                            ‚ûï Agregar Plato al Men√∫
                        </button>
                    </div>

                    <div id="currentMenu" style="margin-top: 40px;">
                        <h3 style="color: #667eea; font-size: 1.8em; margin-bottom: 20px;">Men√∫ Actual</h3>
                        <div id="menuList"></div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-success btn-large" onclick="publishMenu()">
                            üöÄ Publicar Men√∫
                        </button>
                    </div>

                    <div id="whatsappShare" style="display: none;"></div>
                </div>
            </div>

            <!-- SECCI√ìN USUARIO -->
            <div id="user" class="section">
                <div id="communicationChoice" class="communication-choice">
                    <h2>¬øC√≥mo prefieres comunicarte?</h2>
                    <div>
                        <button class="btn btn-primary btn-large" onclick="startChat()">
                            üí¨ Por Chat
                        </button>
                        <button class="btn btn-primary btn-large" onclick="startVoice()">
                            üé§ Por Voz
                        </button>
                    </div>
                </div>

                <div id="userInterface" style="display: none;">
                    <div class="chat-container">
                        <div class="chat-header">
                            <h2>Zepita Bot - Asistente Virtual</h2>
                            <p id="communicationMode"></p>
                        </div>

                        <div class="chat-messages" id="chatMessages"></div>

                        <div class="chat-input">
                            <input type="text" id="userMessage" placeholder="Escribe tu mensaje..." 
                                   onkeypress="if(event.key === 'Enter') sendMessage()">
                            <button class="btn btn-primary" onclick="sendMessage()">Enviar</button>
                            <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">üé§</button>
                        </div>
                    </div>

                    <div id="menuDisplay" style="margin-top: 30px;"></div>
                    <div id="orderSummary" style="margin-top: 30px;"></div>
                </div>
            </div>

            <!-- SECCI√ìN PEDIDOS -->
            <div id="orders" class="section">
                <div class="orders-summary">
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 30px; font-size: 2em;">
                        üìã Resumen de Pedidos
                    </h2>
                    <div id="ordersList"></div>
                    <div id="totalCost"></div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-success btn-large" onclick="exportOrders()">
                            üì• Exportar Lista para Cocina
                        </button>
                        <button class="btn btn-primary btn-large" onclick="generatePDF()">
                            üìÑ Generar PDF
                        </button>
                        <button class="btn btn-primary btn-large" onclick="printOrders()">
                            üñ®Ô∏è Imprimir Lista
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Base de datos local
        let currentMenu = [];
        let userOrders = {};
        let currentUser = '';
        let currentUserFullName = '';
        let currentWeek = '';
        let currentThursday = null; // Fecha del jueves seleccionado
        let communicationMode = '';
        let isVoiceActive = false;
        let recognition = null;
        let isAdminAuthenticated = false;
        let waitingForName = false;
        let justOrdered = false;
        const ADMIN_CODE = '79150361';
        const YEAR = 2026;

        // Inicializar
        window.onload = function() {
            loadFromStorage();
            populateThursdays();
            initVoiceRecognition();
            checkAdminAuth();
            cleanExpiredMenus(); // Limpiar men√∫s expirados al iniciar
        };

        function verifyAdminCode() {
            const code = document.getElementById('adminCode').value;
            const errorDiv = document.getElementById('loginError');
            
            if (code === ADMIN_CODE) {
                isAdminAuthenticated = true;
                localStorage.setItem('zepitaBotAdminAuth', 'true');
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                errorDiv.style.display = 'none';
            } else {
                errorDiv.style.display = 'block';
                document.getElementById('adminCode').value = '';
                document.getElementById('adminCode').focus();
            }
        }

        function checkAdminAuth() {
            const authStatus = localStorage.getItem('zepitaBotAdminAuth');
            if (authStatus === 'true') {
                isAdminAuthenticated = true;
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
            }
        }

        function logoutAdmin() {
            if (confirm('¬øEst√°s seguro de cerrar sesi√≥n?')) {
                isAdminAuthenticated = false;
                localStorage.removeItem('zepitaBotAdminAuth');
                document.getElementById('adminPanel').style.display = 'none';
                document.getElementById('adminLogin').style.display = 'block';
                
                // Limpiar el campo de c√≥digo
                const adminCodeInput = document.getElementById('adminCode');
                if (adminCodeInput) {
                    adminCodeInput.value = '';
                }
                
                // Ocultar mensaje de error si existe
                const errorDiv = document.getElementById('loginError');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
            }
        }

        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'es-ES';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('userMessage').value = transcript;
                    sendMessage();
                };
                
                recognition.onend = function() {
                    isVoiceActive = false;
                    document.getElementById('voiceBtn').classList.remove('active');
                };
            }
        }

        function toggleVoice() {
            if (!recognition) {
                alert('Tu navegador no soporta reconocimiento de voz. Por favor usa Chrome o Edge.');
                return;
            }

            if (isVoiceActive) {
                recognition.stop();
                isVoiceActive = false;
                document.getElementById('voiceBtn').classList.remove('active');
            } else {
                recognition.start();
                isVoiceActive = true;
                document.getElementById('voiceBtn').classList.add('active');
            }
        }

        function speak(text) {
            if (communicationMode === 'voice' && 'speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        }

        function getAllThursdays(year) {
            const thursdays = [];
            let date = new Date(year, 0, 1); // Primer d√≠a del a√±o
            
            // Encontrar el primer jueves del a√±o
            while (date.getDay() !== 4) { // 4 = Jueves
                date.setDate(date.getDate() + 1);
            }
            
            // Recopilar todos los jueves del a√±o
            while (date.getFullYear() === year) {
                thursdays.push(new Date(date));
                date.setDate(date.getDate() + 7); // Siguiente jueves
            }
            
            return thursdays;
        }

        function populateThursdays() {
            const selector = document.getElementById('thursdaySelector');
            const thursdays = getAllThursdays(YEAR);
            const today = new Date();
            
            thursdays.forEach(thursday => {
                const option = document.createElement('option');
                const dateStr = thursday.toISOString().split('T')[0]; // YYYY-MM-DD
                const displayDate = thursday.toLocaleDateString('es-BO', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                option.value = dateStr;
                option.textContent = displayDate;
                
                // Marcar como "pasado" si ya venci√≥
                if (isMenuExpired(thursday)) {
                    option.textContent += ' (Expirado)';
                    option.style.color = '#999';
                }
                
                selector.appendChild(option);
            });
            
            // Seleccionar el jueves m√°s cercano por defecto
            const nextThursday = getNextThursday();
            if (nextThursday) {
                selector.value = nextThursday.toISOString().split('T')[0];
                updateThursdayDisplay();
            }
        }

        function getNextThursday() {
            const today = new Date();
            const thursdays = getAllThursdays(YEAR);
            
            // Encontrar el pr√≥ximo jueves que no haya expirado
            for (let thursday of thursdays) {
                if (!isMenuExpired(thursday)) {
                    return thursday;
                }
            }
            
            return thursdays[0]; // Si todos expiraron, devolver el primero
        }

        function updateThursdayDisplay() {
            const selector = document.getElementById('thursdaySelector');
            const dateStr = selector.value;
            
            if (!dateStr) {
                document.getElementById('thursdayDisplay').textContent = '';
                return;
            }
            
            currentThursday = new Date(dateStr + 'T00:00:00');
            currentWeek = dateStr; // Usamos la fecha como identificador
            
            const displayDate = currentThursday.toLocaleDateString('es-BO', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('thursdayDisplay').textContent = `Men√∫ para: ${displayDate}`;
            
            // Mostrar advertencias seg√∫n el estado del men√∫
            const deadlineWarning = document.getElementById('deadlineWarning');
            const menuExpired = document.getElementById('menuExpired');
            const menuDeleteWarning = document.getElementById('menuDeleteWarning');
            
            if (isMenuExpired(currentThursday)) {
                deadlineWarning.style.display = 'none';
                menuExpired.style.display = 'block';
                menuDeleteWarning.style.display = 'none';
            } else if (shouldMenuBeDeleted(currentThursday)) {
                deadlineWarning.style.display = 'none';
                menuExpired.style.display = 'none';
                menuDeleteWarning.style.display = 'block';
            } else {
                deadlineWarning.style.display = 'block';
                menuExpired.style.display = 'none';
                menuDeleteWarning.style.display = 'none';
            }
            
            displayMenu();
        }

        function isMenuExpired(thursdayDate) {
            const now = new Date();
            const deadline = new Date(thursdayDate);
            deadline.setHours(18, 0, 0, 0); // Jueves a las 18:00
            
            return now > deadline;
        }

        function shouldMenuBeDeleted(thursdayDate) {
            const now = new Date();
            const deleteDate = new Date(thursdayDate);
            deleteDate.setDate(deleteDate.getDate() + 3); // 3 d√≠as despu√©s
            deleteDate.setHours(23, 59, 59, 999); // Domingo a las 23:59
            
            return now > deleteDate;
        }

        function cleanExpiredMenus() {
            // Eliminar men√∫s que tienen m√°s de 3 d√≠as
            currentMenu = currentMenu.filter(dish => {
                const thursdayDate = new Date(dish.week + 'T00:00:00');
                return !shouldMenuBeDeleted(thursdayDate);
            });
            
            // Eliminar pedidos de men√∫s eliminados
            const validWeeks = new Set(currentMenu.map(d => d.week));
            
            Object.keys(userOrders).forEach(userId => {
                const userData = userOrders[userId];
                if (userData.orders) {
                    userData.orders = userData.orders.filter(order => validWeeks.has(order.week));
                    
                    // Si el usuario no tiene pedidos, eliminar su entrada
                    if (userData.orders.length === 0) {
                        delete userOrders[userId];
                    }
                }
            });
            
            saveToStorage();
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');

            if (section === 'orders') {
                displayOrders();
            }
        }

        function addDishToMenu() {
            const name = document.getElementById('dishName').value.trim();
            const price = parseFloat(document.getElementById('dishPrice').value);
            const description = document.getElementById('dishDescription').value.trim();

            if (!name || !price) {
                alert('Por favor completa el nombre y precio del plato');
                return;
            }

            if (!currentWeek) {
                alert('Por favor selecciona un jueves para el men√∫');
                return;
            }

            // Verificar si el men√∫ ya expir√≥
            if (isMenuExpired(currentThursday)) {
                alert('‚ùå No se pueden agregar platos a este men√∫. El plazo venci√≥ el jueves a las 18:00 hrs.');
                return;
            }

            const dish = {
                id: Date.now(),
                name: name,
                price: price,
                description: description,
                week: currentWeek
            };

            currentMenu.push(dish);
            saveToStorage();
            displayMenu();

            // Limpiar formulario
            document.getElementById('dishName').value = '';
            document.getElementById('dishPrice').value = '';
            document.getElementById('dishDescription').value = '';

            alert('‚úÖ Plato agregado al men√∫');
        }

        function displayMenu() {
            const menuList = document.getElementById('menuList');
            const weekMenu = currentMenu.filter(dish => dish.week === currentWeek);
            
            if (weekMenu.length === 0) {
                menuList.innerHTML = '<p style="text-align: center; color: #999; font-size: 1.2em;">No hay platos agregados a√∫n</p>';
                return;
            }

            menuList.innerHTML = weekMenu.map(dish => `
                <div class="menu-item">
                    <div class="menu-item-header">
                        <h3>${dish.name}</h3>
                        <span class="price">Bs. ${dish.price.toFixed(2)}</span>
                    </div>
                    ${dish.description ? `<p style="color: #666;">${dish.description}</p>` : ''}
                    <button class="btn btn-danger" onclick="removeDish(${dish.id})" style="margin-top: 10px;">
                        üóëÔ∏è Eliminar
                    </button>
                </div>
            `).join('');
        }

        function removeDish(dishId) {
            if (confirm('¬øEst√°s seguro de eliminar este plato?')) {
                currentMenu = currentMenu.filter(dish => dish.id !== dishId);
                saveToStorage();
                displayMenu();
            }
        }

        function publishMenu() {
            const weekMenu = currentMenu.filter(dish => dish.week === currentWeek);
            
            if (weekMenu.length === 0) {
                alert('‚ùå No hay platos en el men√∫ para publicar');
                return;
            }

            const whatsappDiv = document.getElementById('whatsappShare');
            
            const thursdayDate = new Date(currentWeek + 'T00:00:00');
            const displayDate = thursdayDate.toLocaleDateString('es-BO', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let menuText = `üçΩÔ∏è *MEN√ö SEMANAL ZEPITA BOT*\n`;
            menuText += `üìÖ ${displayDate}\n`;
            menuText += `‚è∞ *Pedidos hasta el jueves a las 18:00 hrs*\n\n`;
            
            weekMenu.forEach((dish, index) => {
                menuText += `${index + 1}. *${dish.name}* - Bs. ${dish.price.toFixed(2)}\n`;
                if (dish.description) {
                    menuText += `   ${dish.description}\n`;
                }
                menuText += `\n`;
            });
            
            menuText += `\nüì± Haz tu pedido con Zepita Bot`;

            const encodedText = encodeURIComponent(menuText);
            const whatsappUrl = `https://wa.me/?text=${encodedText}`;

            whatsappDiv.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ ¬°Men√∫ listo para publicar!
                </div>
                <div class="whatsapp-section">
                    <h3>üì± Compartir en WhatsApp</h3>
                    <p style="font-size: 1.1em;">Comparte este men√∫ con tu grupo de WhatsApp</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">
                        <strong>Recuerda:</strong> Los pedidos se aceptar√°n hasta el jueves a las 18:00 hrs
                    </p>
                    <a href="${whatsappUrl}" target="_blank" class="whatsapp-link">
                        üì≤ Abrir WhatsApp
                    </a>
                </div>
            `;
            whatsappDiv.style.display = 'block';

            alert('‚úÖ Men√∫ publicado correctamente!');
        }

        function startChat() {
            communicationMode = 'chat';
            document.getElementById('communicationChoice').style.display = 'none';
            document.getElementById('userInterface').style.display = 'block';
            document.getElementById('communicationMode').textContent = 'üí¨ Modo: Chat';
            
            askForUserName();
        }

        function startVoice() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Tu navegador no soporta reconocimiento de voz. Por favor usa el modo chat o abre esta p√°gina en Chrome/Edge.');
                return;
            }
            
            communicationMode = 'voice';
            document.getElementById('communicationChoice').style.display = 'none';
            document.getElementById('userInterface').style.display = 'block';
            document.getElementById('communicationMode').textContent = 'üé§ Modo: Voz';
            
            askForUserName();
        }

        function askForUserName() {
            const welcomeMsg = '¬°Hola! Soy Zepita Bot, tu asistente de men√∫s. üòä\n\nPara comenzar, por favor dime tu nombre y apellido.';
            addBotMessage(welcomeMsg);
            speak(welcomeMsg);
            
            // Marcar que estamos esperando el nombre
            waitingForName = true;
        }

        function addBotMessage(message) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message bot';
            messageEl.textContent = message;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addUserMessage(message) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message user';
            messageEl.textContent = message;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('userMessage');
            const message = input.value.trim();
            
            if (!message) return;
            
            addUserMessage(message);
            input.value = '';
            
            processUserMessage(message);
        }

        function processUserMessage(message) {
            const lowerMsg = message.toLowerCase();
            
            // Si estamos esperando el nombre del usuario
            if (waitingForName) {
                currentUserFullName = message.trim();
                currentUser = currentUserFullName;
                waitingForName = false;
                
                const response = `¬°Mucho gusto, ${currentUserFullName}! üòä\n\n¬øTe gustar√≠a ver el men√∫ de esta semana?`;
                addBotMessage(response);
                speak(response);
                return;
            }
            
            // Si acaba de ordenar algo, preguntamos si quiere agregar m√°s
            if (justOrdered) {
                if (lowerMsg.includes('si') || lowerMsg.includes('s√≠') || lowerMsg.includes('otro') || lowerMsg.includes('m√°s') || lowerMsg.includes('mas')) {
                    justOrdered = false;
                    showMenuToUser();
                } else if (lowerMsg.includes('no') || lowerMsg.includes('listo') || lowerMsg.includes('suficiente') || lowerMsg.includes('terminar')) {
                    justOrdered = false;
                    const response = '¬°Perfecto! Tu pedido ha sido registrado. Gracias por usar Zepita Bot. üòä\n\nSi necesitas agregar algo m√°s, solo d√≠melo.';
                    addBotMessage(response);
                    speak(response);
                } else {
                    const response = '¬øDeseas agregar otro plato a tu pedido? Responde "s√≠" o "no".';
                    addBotMessage(response);
                    speak(response);
                }
                return;
            }
            
            if (lowerMsg.includes('menu') || lowerMsg.includes('men√∫') || lowerMsg.includes('ver') || lowerMsg.includes('mostrar') || lowerMsg.includes('si') || lowerMsg.includes('s√≠')) {
                showMenuToUser();
            } else if (lowerMsg.includes('pedir') || lowerMsg.includes('ordenar') || lowerMsg.includes('quiero')) {
                const response = 'Por favor indica el n√∫mero del plato que deseas ordenar. Por ejemplo: "Quiero el plato 1"';
                addBotMessage(response);
                speak(response);
            } else if (lowerMsg.match(/\d+/)) {
                const number = parseInt(lowerMsg.match(/\d+/)[0]);
                orderDish(number, message);
            } else {
                const response = 'Puedo ayudarte a ver el men√∫ o hacer tu pedido. ¬øQu√© te gustar√≠a hacer?';
                addBotMessage(response);
                speak(response);
            }
        }

        function showMenuToUser() {
            const weekMenu = currentMenu.filter(dish => dish.week === currentWeek);
            
            if (weekMenu.length === 0) {
                const response = 'Lo siento, a√∫n no hay men√∫ disponible para esta semana. üòî';
                addBotMessage(response);
                speak(response);
                return;
            }

            // Verificar si el men√∫ ya expir√≥
            const thursdayDate = new Date(currentWeek + 'T00:00:00');
            if (isMenuExpired(thursdayDate)) {
                const response = 'Lo siento, el plazo para hacer pedidos de este men√∫ ya venci√≥ (jueves 18:00 hrs). üòî';
                addBotMessage(response);
                speak(response);
                return;
            }

            let menuHTML = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">';
            menuHTML += `<h3 style="color: #667eea; margin-bottom: 20px;">üçΩÔ∏è Men√∫ del ${currentThursday.toLocaleDateString('es-BO', { weekday: 'long', day: 'numeric', month: 'long' })}</h3>`;
            
            // Calcular tiempo restante
            const now = new Date();
            const deadline = new Date(thursdayDate);
            deadline.setHours(18, 0, 0, 0);
            const hoursLeft = Math.floor((deadline - now) / (1000 * 60 * 60));
            
            if (hoursLeft > 0 && hoursLeft <= 24) {
                menuHTML += `<div class="alert alert-info" style="margin-bottom: 15px;">‚è∞ Tienes ${hoursLeft} horas para hacer tu pedido</div>`;
            }
            
            let menuText = 'Aqu√≠ est√° el men√∫: ';
            
            weekMenu.forEach((dish, index) => {
                menuHTML += `
                    <div class="menu-item" style="margin-bottom: 15px;">
                        <strong>${index + 1}. ${dish.name}</strong> - Bs. ${dish.price.toFixed(2)}<br>
                        ${dish.description ? `<small>${dish.description}</small><br>` : ''}
                        <button class="btn btn-primary" onclick="orderDishById(${dish.id}, ${index + 1})" style="margin-top: 10px;">
                            üõí Ordenar
                        </button>
                    </div>
                `;
                menuText += `${index + 1}, ${dish.name} por ${dish.price} bolivianos. `;
            });
            
            menuHTML += '</div>';
            document.getElementById('menuDisplay').innerHTML = menuHTML;
            
            const response = 'Aqu√≠ est√° el men√∫ disponible. Puedes hacer clic en "Ordenar" o decirme el n√∫mero del plato que deseas. üòä';
            addBotMessage(response);
            speak(menuText + response);
        }

        function orderDishById(dishId, dishNumber) {
            const dish = currentMenu.find(d => d.id === dishId);
            if (!dish) return;
            
            // Verificar si el men√∫ ya expir√≥
            const thursdayDate = new Date(dish.week + 'T00:00:00');
            if (isMenuExpired(thursdayDate)) {
                alert('‚ùå Este men√∫ ya no acepta pedidos. El plazo venci√≥ el jueves a las 18:00 hrs.');
                const response = 'Lo siento, este men√∫ ya no acepta pedidos. El plazo de registro venci√≥.';
                addBotMessage(response);
                speak(response);
                return;
            }
            
            const comment = prompt(`¬øAlg√∫n comentario especial para tu ${dish.name}?\n(Por ejemplo: sin cebolla, bien cocido, etc.)\n\nPuedes dejarlo en blanco si no tienes comentarios.`);
            
            if (!userOrders[currentUser]) {
                userOrders[currentUser] = {
                    fullName: currentUserFullName,
                    orders: []
                };
            }
            
            userOrders[currentUser].orders.push({
                dishId: dish.id,
                dishName: dish.name,
                price: dish.price,
                comment: comment || '',
                week: currentWeek
            });
            
            saveToStorage();
            updateUserOrderSummary();
            
            // Activar el estado de "acaba de ordenar"
            justOrdered = true;
            
            const response = `‚úÖ Perfecto! He agregado ${dish.name} a tu pedido${comment ? ' con tus comentarios' : ''}.\n\n¬øDeseas agregar otro plato m√°s a tu pedido?`;
            addBotMessage(response);
            speak(response);
        }

        function orderDish(number, fullMessage) {
            const weekMenu = currentMenu.filter(dish => dish.week === currentWeek);
            
            if (number < 1 || number > weekMenu.length) {
                const response = 'Lo siento, ese n√∫mero de plato no existe. Por favor elige un n√∫mero v√°lido del men√∫.';
                addBotMessage(response);
                speak(response);
                return;
            }
            
            const dish = weekMenu[number - 1];
            
            // Verificar si el men√∫ ya expir√≥
            const thursdayDate = new Date(dish.week + 'T00:00:00');
            if (isMenuExpired(thursdayDate)) {
                const response = 'Lo siento, este men√∫ ya no acepta pedidos. El plazo de registro venci√≥ el jueves a las 18:00 hrs. üòî';
                addBotMessage(response);
                speak(response);
                return;
            }
            
            // Detectar si hay comentarios en el mensaje
            let comment = '';
            const commentPatterns = ['sin', 'con', 'extra', 'poco', 'mucho', 'bien', 'medio'];
            if (commentPatterns.some(pattern => fullMessage.toLowerCase().includes(pattern))) {
                comment = fullMessage;
            }
            
            if (!userOrders[currentUser]) {
                userOrders[currentUser] = {
                    fullName: currentUserFullName,
                    orders: []
                };
            }
            
            userOrders[currentUser].orders.push({
                dishId: dish.id,
                dishName: dish.name,
                price: dish.price,
                comment: comment,
                week: currentWeek
            });
            
            saveToStorage();
            updateUserOrderSummary();
            
            // Activar el estado de "acaba de ordenar"
            justOrdered = true;
            
            const response = `‚úÖ Perfecto! He agregado ${dish.name} a tu pedido${comment ? ' con tus comentarios' : ''}.\n\n¬øDeseas agregar otro plato m√°s a tu pedido?`;
            addBotMessage(response);
            speak(response);
        }

        function updateUserOrderSummary() {
            const userData = userOrders[currentUser];
            if (!userData || !userData.orders) {
                document.getElementById('orderSummary').innerHTML = '';
                return;
            }
            
            const orders = userData.orders;
            const weekOrders = orders.filter(order => order.week === currentWeek);
            
            if (weekOrders.length === 0) {
                document.getElementById('orderSummary').innerHTML = '';
                return;
            }
            
            let total = weekOrders.reduce((sum, order) => sum + order.price, 0);
            
            let html = '<div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-top: 20px;">';
            html += `<h3 style="color: #667eea;">üìù Pedido de ${currentUserFullName}</h3>`;
            
            weekOrders.forEach((order, index) => {
                html += `
                    <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px;">
                        <strong>${index + 1}. ${order.dishName}</strong> - Bs. ${order.price.toFixed(2)}<br>
                        ${order.comment ? `<small style="color: #666;">üí¨ ${order.comment}</small>` : ''}
                    </div>
                `;
            });
            
            html += `<div style="background: #28a745; color: white; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                <strong style="font-size: 1.3em;">Total: Bs. ${total.toFixed(2)}</strong>
            </div>`;
            html += '</div>';
            
            document.getElementById('orderSummary').innerHTML = html;
        }

        function displayOrders() {
            const ordersList = document.getElementById('ordersList');
            const totalCost = document.getElementById('totalCost');
            
            if (Object.keys(userOrders).length === 0) {
                ordersList.innerHTML = '<p style="text-align: center; color: #999; font-size: 1.2em;">No hay pedidos a√∫n</p>';
                totalCost.innerHTML = '';
                return;
            }
            
            // Agrupar por plato
            const dishCount = {};
            let grandTotal = 0;
            
            Object.keys(userOrders).forEach(userId => {
                const userData = userOrders[userId];
                const orders = userData.orders || [];
                const weekOrders = orders.filter(order => order.week === currentWeek);
                
                weekOrders.forEach(order => {
                    const key = order.dishName;
                    if (!dishCount[key]) {
                        dishCount[key] = {
                            name: order.dishName,
                            price: order.price,
                            count: 0,
                            users: [],
                            total: 0
                        };
                    }
                    dishCount[key].count++;
                    dishCount[key].total += order.price;
                    dishCount[key].users.push({
                        user: userData.fullName || userId,
                        comment: order.comment
                    });
                    grandTotal += order.price;
                });
            });
            
            let html = '';
            
            // Resumen por usuario
            Object.keys(userOrders).forEach(userId => {
                const userData = userOrders[userId];
                const orders = userData.orders || [];
                const weekOrders = orders.filter(order => order.week === currentWeek);
                if (weekOrders.length === 0) return;
                
                const userTotal = weekOrders.reduce((sum, order) => sum + order.price, 0);
                
                html += `
                    <div class="order-card">
                        <h3>üë§ ${userData.fullName || userId}</h3>
                        ${weekOrders.map(order => `
                            <div class="order-item">
                                <strong>${order.dishName}</strong> - Bs. ${order.price.toFixed(2)}
                                ${order.comment ? `<br><small style="color: #666;">üí¨ ${order.comment}</small>` : ''}
                            </div>
                        `).join('')}
                        <div style="text-align: right; margin-top: 10px; font-size: 1.2em;">
                            <strong>Subtotal: Bs. ${userTotal.toFixed(2)}</strong>
                        </div>
                    </div>
                `;
            });
            
            // Resumen consolidado para cocina
            html += `
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-top: 30px; border: 3px solid #ffc107;">
                    <h3 style="color: #856404; margin-bottom: 20px; font-size: 1.5em;">
                        üë®‚Äçüç≥ RESUMEN PARA COCINA
                    </h3>
            `;
            
            Object.keys(dishCount).forEach(dishName => {
                const dish = dishCount[dishName];
                html += `
                    <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 5px solid #ffc107;">
                        <strong style="font-size: 1.2em;">${dish.name}</strong>
                        <div style="margin-top: 10px;">
                            <span style="background: #28a745; color: white; padding: 5px 15px; border-radius: 5px; font-size: 1.1em;">
                                Cantidad: ${dish.count}
                            </span>
                        </div>
                        ${dish.users.some(u => u.comment) ? `
                            <div style="margin-top: 10px;">
                                <strong>Comentarios especiales:</strong>
                                ${dish.users.filter(u => u.comment).map(u => `
                                    <div style="margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 5px;">
                                        ‚Ä¢ ${u.user}: ${u.comment}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            
            ordersList.innerHTML = html;
            
            // Contar total de pedidos
            let totalOrderCount = 0;
            Object.keys(userOrders).forEach(userId => {
                const userData = userOrders[userId];
                const orders = userData.orders || [];
                totalOrderCount += orders.filter(o => o.week === currentWeek).length;
            });
            
            totalCost.innerHTML = `
                <div class="total-section">
                    <h2>üí∞ TOTAL GENERAL</h2>
                    <h2 style="font-size: 2.5em; margin-top: 15px;">Bs. ${grandTotal.toFixed(2)}</h2>
                    <p style="font-size: 1.2em; margin-top: 10px;">
                        Total de pedidos: ${totalOrderCount}
                    </p>
                </div>
            `;
        }

        function exportOrders() {
            const dishCount = {};
            let grandTotal = 0;
            
            Object.keys(userOrders).forEach(userId => {
                const userData = userOrders[userId];
                const orders = userData.orders || [];
                const weekOrders = orders.filter(order => order.week === currentWeek);
                weekOrders.forEach(order => {
                    const key = order.dishName;
                    if (!dishCount[key]) {
                        dishCount[key] = {
                            name: order.dishName,
                            price: order.price,
                            count: 0,
                            users: [],
                            total: 0
                        };
                    }
                    dishCount[key].count++;
                    dishCount[key].total += order.price;
                    dishCount[key].users.push({
                        user: userData.fullName || userId,
                        comment: order.comment
                    });
                    grandTotal += order.price;
                });
            });
            
            let text = `LISTA DE PEDIDOS - ZEPITA BOT\n`;
            text += `Semana: ${currentWeek}\n`;
            text += `Fecha de exportaci√≥n: ${new Date().toLocaleString('es-BO')}\n`;
            text += `\n${'='.repeat(50)}\n`;
            text += `RESUMEN POR USUARIO\n`;
            text += `${'='.repeat(50)}\n\n`;
            
            // Listado por usuario
            Object.keys(userOrders).forEach(userId => {
                const userData = userOrders[userId];
                const orders = userData.orders || [];
                const weekOrders = orders.filter(order => order.week === currentWeek);
                if (weekOrders.length === 0) return;
                
                const userTotal = weekOrders.reduce((sum, order) => sum + order.price, 0);
                
                text += `USUARIO: ${userData.fullName || userId}\n`;
                weekOrders.forEach((order, index) => {
                    text += `  ${index + 1}. ${order.dishName} - Bs. ${order.price.toFixed(2)}\n`;
                    if (order.comment) {
                        text += `     Comentario: ${order.comment}\n`;
                    }
                });
                text += `  Subtotal: Bs. ${userTotal.toFixed(2)}\n\n`;
            });
            
            text += `${'='.repeat(50)}\n`;
            text += `RESUMEN PARA COCINA\n`;
            text += `${'='.repeat(50)}\n\n`;
            
            Object.keys(dishCount).forEach(dishName => {
                const dish = dishCount[dishName];
                text += `${dish.name}\n`;
                text += `Cantidad a preparar: ${dish.count}\n`;
                text += `Precio unitario: Bs. ${dish.price.toFixed(2)}\n`;
                text += `Subtotal: Bs. ${dish.total.toFixed(2)}\n`;
                
                if (dish.users.some(u => u.comment)) {
                    text += `\nComentarios especiales:\n`;
                    dish.users.filter(u => u.comment).forEach(u => {
                        text += `  - ${u.user}: ${u.comment}\n`;
                    });
                }
                text += `\n${'-'.repeat(50)}\n\n`;
            });
            
            // Contar total de pedidos
            let totalOrderCount = 0;
            Object.keys(userOrders).forEach(userId => {
                const userData = userOrders[userId];
                const orders = userData.orders || [];
                totalOrderCount += orders.filter(o => o.week === currentWeek).length;
            });
            
            text += `\n${'='.repeat(50)}\n`;
            text += `TOTAL GENERAL: Bs. ${grandTotal.toFixed(2)}\n`;
            text += `Total de pedidos: ${totalOrderCount}\n`;
            text += `${'='.repeat(50)}\n`;
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pedidos_zepita_bot_${currentWeek}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Lista exportada correctamente!');
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            
            if (!jsPDF) {
                alert('Error al cargar la librer√≠a PDF. Por favor recarga la p√°gina.');
                return;
            }
            
            const dishCount = {};
            let grandTotal = 0;
            
            Object.keys(userOrders).forEach(userId => {
                const userData = userOrders[userId];
                const orders = userData.orders || [];
                const weekOrders = orders.filter(order => order.week === currentWeek);
                weekOrders.forEach(order => {
                    const key = order.dishName;
                    if (!dishCount[key]) {
                        dishCount[key] = {
                            name: order.dishName,
                            price: order.price,
                            count: 0,
                            users: [],
                            total: 0
                        };
                    }
                    dishCount[key].count++;
                    dishCount[key].total += order.price;
                    dishCount[key].users.push({
                        user: userData.fullName || userId,
                        comment: order.comment
                    });
                    grandTotal += order.price;
                });
            });
            
            if (Object.keys(userOrders).length === 0) {
                alert('No hay pedidos para generar el PDF');
                return;
            }
            
            const doc = new jsPDF();
            let yPosition = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            const maxWidth = pageWidth - (margin * 2);
            
            // Funci√≥n para agregar nueva p√°gina si es necesario
            function checkPageBreak(requiredSpace) {
                if (yPosition + requiredSpace > pageHeight - 20) {
                    doc.addPage();
                    yPosition = 20;
                    return true;
                }
                return false;
            }
            
            // T√≠tulo
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LISTA DE PEDIDOS - ZEPITA BOT', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 10;
            
            // Fecha del men√∫
            const thursdayDate = new Date(currentWeek + 'T00:00:00');
            const displayDate = thursdayDate.toLocaleDateString('es-BO', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Menu: ${displayDate}`, pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 6;
            
            const exportDate = new Date().toLocaleString('es-BO');
            doc.setFontSize(10);
            doc.text(`Generado: ${exportDate}`, pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 15;
            
            // L√≠nea separadora
            doc.setLineWidth(0.5);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 10;
            
            // SECCI√ìN: Resumen por Usuario
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMEN POR USUARIO', margin, yPosition);
            yPosition += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            Object.keys(userOrders).forEach(userId => {
                const userData = userOrders[userId];
                const orders = userData.orders || [];
                const weekOrders = orders.filter(order => order.week === currentWeek);
                if (weekOrders.length === 0) return;
                
                const userTotal = weekOrders.reduce((sum, order) => sum + order.price, 0);
                
                checkPageBreak(40);
                
                // Nombre de usuario
                doc.setFont(undefined, 'bold');
                doc.text(`Usuario: ${userData.fullName || userId}`, margin, yPosition);
                yPosition += 6;
                
                doc.setFont(undefined, 'normal');
                
                // Pedidos del usuario
                weekOrders.forEach((order, index) => {
                    checkPageBreak(15);
                    
                    const orderText = `  ${index + 1}. ${order.dishName} - Bs. ${order.price.toFixed(2)}`;
                    doc.text(orderText, margin + 5, yPosition);
                    yPosition += 5;
                    
                    if (order.comment) {
                        checkPageBreak(10);
                        doc.setFontSize(9);
                        doc.setTextColor(100);
                        const commentLines = doc.splitTextToSize(`     Comentario: ${order.comment}`, maxWidth - 10);
                        commentLines.forEach(line => {
                            checkPageBreak(5);
                            doc.text(line, margin + 5, yPosition);
                            yPosition += 4;
                        });
                        doc.setFontSize(10);
                        doc.setTextColor(0);
                    }
                });
                
                // Subtotal del usuario
                doc.setFont(undefined, 'bold');
                doc.text(`  Subtotal: Bs. ${userTotal.toFixed(2)}`, margin + 5, yPosition);
                yPosition += 10;
                doc.setFont(undefined, 'normal');
            });
            
            // L√≠nea separadora
            checkPageBreak(20);
            doc.setLineWidth(0.5);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 10;
            
            // SECCI√ìN: Resumen para Cocina
            checkPageBreak(30);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setFillColor(255, 243, 205);
            doc.rect(margin, yPosition - 5, maxWidth, 10, 'F');
            doc.text('RESUMEN PARA COCINA', margin + 5, yPosition);
            yPosition += 12;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            Object.keys(dishCount).forEach(dishName => {
                const dish = dishCount[dishName];
                
                checkPageBreak(30);
                
                // Nombre del plato
                doc.setFont(undefined, 'bold');
                doc.text(dish.name, margin, yPosition);
                yPosition += 6;
                
                doc.setFont(undefined, 'normal');
                doc.text(`Cantidad a preparar: ${dish.count}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`Precio unitario: Bs. ${dish.price.toFixed(2)}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`Subtotal: Bs. ${dish.total.toFixed(2)}`, margin + 5, yPosition);
                yPosition += 7;
                
                // Comentarios especiales
                if (dish.users.some(u => u.comment)) {
                    checkPageBreak(20);
                    doc.setFont(undefined, 'bold');
                    doc.text('Comentarios especiales:', margin + 5, yPosition);
                    yPosition += 5;
                    doc.setFont(undefined, 'normal');
                    
                    dish.users.filter(u => u.comment).forEach(u => {
                        checkPageBreak(10);
                        doc.setFontSize(9);
                        const commentText = `  - ${u.user}: ${u.comment}`;
                        const lines = doc.splitTextToSize(commentText, maxWidth - 10);
                        lines.forEach(line => {
                            checkPageBreak(5);
                            doc.text(line, margin + 7, yPosition);
                            yPosition += 4;
                        });
                        doc.setFontSize(10);
                    });
                }
                
                yPosition += 8;
                doc.setDrawColor(200);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 8;
            });
            
            // Contar total de pedidos
            let totalOrderCount = 0;
            Object.keys(userOrders).forEach(userId => {
                const userData = userOrders[userId];
                const orders = userData.orders || [];
                totalOrderCount += orders.filter(o => o.week === currentWeek).length;
            });
            
            // TOTAL GENERAL
            checkPageBreak(35);
            yPosition += 5;
            doc.setLineWidth(1);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 10;
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('TOTAL GENERAL', margin, yPosition);
            yPosition += 8;
            
            doc.setFontSize(20);
            doc.text(`Bs. ${grandTotal.toFixed(2)}`, margin, yPosition);
            yPosition += 8;
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de pedidos: ${totalOrderCount}`, margin, yPosition);
            
            // Guardar PDF
            const fileName = `pedidos_zepita_bot_${currentWeek}.pdf`;
            doc.save(fileName);
            
            alert('‚úÖ PDF generado correctamente!');
        }

        function printOrders() {
            window.print();
        }

        function saveToStorage() {
            localStorage.setItem('zepitaBotMenu', JSON.stringify(currentMenu));
            localStorage.setItem('zepitaBotOrders', JSON.stringify(userOrders));
            localStorage.setItem('zepitaBotWeek', currentWeek);
        }

        function loadFromStorage() {
            const savedMenu = localStorage.getItem('zepitaBotMenu');
            const savedOrders = localStorage.getItem('zepitaBotOrders');
            const savedWeek = localStorage.getItem('zepitaBotWeek');
            
            if (savedMenu) currentMenu = JSON.parse(savedMenu);
            if (savedOrders) userOrders = JSON.parse(savedOrders);
            if (savedWeek) currentWeek = savedWeek;
            
            displayMenu();
        }
    </script>
</body>
</html>
